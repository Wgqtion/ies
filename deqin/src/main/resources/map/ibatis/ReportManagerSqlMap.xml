<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" 
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap> 

<!-- 停车场进出次数统计-->
<select id="report.carInOutTotal.total" resultClass="mapBean" parameterClass="map" >
	SELECT 
		PT.PLNAME AS name,INCAR.innum,OUTCAR.outnum
	FROM
	(
		SELECT 
			PL."NAME" AS PLNAME,PL."ID" AS PLID,PAS."NAME" AS PASNAME,PAS."ID" AS PASID
		FROM
			T_PARKING_LOT PL
		LEFT JOIN T_PASSAGES PAS ON PL."ID"=PAS.PARKINGLOT_ID
		UNION
		SELECT 
			'未识别',-1,'未识别',-1
		FROM
			DUAL
	)  PT 
	
	LEFT JOIN (
		SELECT 
			COUNT(*) innum,
			NVL(PL."ID".-1) AS PLID,
			NVL(PAS."ID".-1) AS PASID
		FROM 
			T_PARKING_ORDER PO
		LEFT JOIN T_PASSAGES PAS ON PO.IN_SCHOOL_DOOR_NAME=PAS."ID"
		LEFT JOIN T_PARKING_LOT PL ON PL."ID"=PAS.PARKINGLOT_ID  
		WHERE 
			1=1
			<isNotEmpty    property="GTE_startTime">
			AND <![CDATA[to_char(PO.IN_TIME,'yyyy-MM-dd') >= #GTE_startTime#]]>
			</isNotEmpty>
			<isNotEmpty    property="LTE_endTime">
			AND <![CDATA[to_char(PO.IN_TIME,'yyyy-MM-dd') <= #LTE_endTime#]]>			 
			</isNotEmpty>
		GROUP BY 
			NVL(PL."ID".-1)
	)	INCAR ON INCAR.PLID=PT.PLID
	LEFT JOIN (
		SELECT 
			COUNT(*) outnum,
			NVL(PL."ID".-1) AS PLID,
			NVL(PAS."ID".-1) AS PASID
		FROM 
			T_PARKING_ORDER PO
		LEFT JOIN T_PASSAGES PAS ON PO.OUT_SCHOOL_DOOR_NAME=PAS."ID"
		LEFT JOIN T_PARKING_LOT PL ON PL."ID"=PAS.PARKINGLOT_ID  
		WHERE 
			1=1
			<isNotEmpty    property="GTE_startTime">
			AND <![CDATA[to_char(PO.OUT_TIME,'yyyy-MM-dd') >= #GTE_startTime#]]>
			</isNotEmpty>
			<isNotEmpty    property="LTE_endTime">
			AND <![CDATA[to_char(PO.OUT_TIME,'yyyy-MM-dd') <= #LTE_endTime#]]>			 
			</isNotEmpty>
		GROUP BY 
			NVL(PL."ID".-1)
	)	OUTCAR ON OUTCAR.PLID=PT.PLID
	GROUP BY 
			PT.PLID,INCAR.innum,OUTCAR.outnum
	ORDER BY PT.PLNAME
</select>



<!-- 停车场收费统计-->
<select id="report.carChargeTotal.total" resultClass="mapBean" parameterClass="map" >
	SELECT 
		SUM(PO.YS_PAY_AMOUNT) AS YS_PAY_AMOUNT,
		SUM(PO.SS_PAY_AMOUNT) AS SS_PAY_AMOUNT,
		NVL(PL."NAME",'未识别') AS name
	FROM 
		T_PARKING_ORDER PO
	LEFT JOIN T_PASSAGES PAS ON PO.IN_SCHOOL_DOOR_NAME=PAS."ID"
	LEFT JOIN T_PARKING_LOT PL ON PL."ID"=PAS.PARKINGLOT_ID  
	WHERE 
		1=1
		<isNotEmpty    property="GTE_startTime">
		AND <![CDATA[to_char(PO.PAY_TIME,'yyyy-MM-dd') >= #GTE_startTime#]]>
		</isNotEmpty>
		<isNotEmpty    property="LTE_endTime">
		AND <![CDATA[to_char(PO.PAY_TIME,'yyyy-MM-dd') <= #LTE_endTime#]]>			 
		</isNotEmpty>
	GROUP BY 
		NVL(PL."NAME",'未识别')
</select>
	
	
	
</sqlMap>


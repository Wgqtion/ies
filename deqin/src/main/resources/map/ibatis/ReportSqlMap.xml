<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" 
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap> 
<!-- 查询车位状态-->
<select id="report.parkingGarageStatus.total" resultClass="mapBean" parameterClass="com.vsc.modules.entity.ReportView" >
	SELECT
		*
	FROM
	(
		SELECT
			PL."NAME" AS PLNAME,
			PLA."NAME" AS PLANAME,
			PG."NAME" AS PGNAME,
			PG."CODE" AS PGCODE,
			PG.XCOORDINATE,
			PG.YCOORDINATE,
			PV.PLATE_NO AS PLATENO,
			TO_CHAR (
				PV.IN_TIME,
				'yyyy-MM-dd HH:mm:ss'
			) AS INTIME,
			PV.STATUS AS iscarstatus
		FROM
			T_PARKING_GARAGE PG
		LEFT JOIN T_PARKING_LOT_AREA PLA ON PG.PARKING_LOT_AREA_ID = PLA."ID"
		LEFT JOIN T_PARKING_LOT PL ON PLA.PARKING_LOT_ID = PL."ID"
		LEFT JOIN (
			SELECT
				*
			FROM
				(
					SELECT
						PARKING_CODE,
						CREATE_TIME,
						CAMERA_IP,
						STATUS,
						PLATE_NO,
						IN_TIME,
						ROW_NUMBER () OVER (
							PARTITION BY PARKING_CODE
							ORDER BY
								CREATE_TIME DESC,
								"ID" DESC
						) rn
					FROM
						T_PARKING_VIDEO
				) PV
			WHERE
				rn = 1
		) PV ON PG."NAME" = PV.PARKING_CODE
	) SurplusTotal
	WHERE
	1 = 1
	<isNotEmpty    property="value">
		AND PLATENO LIKE '%'||#value#||'%'
	</isNotEmpty>
	<isNotEmpty    property="entity.name">
		AND PGNAME  LIKE '%'||#entity.name#||'%'
	</isNotEmpty>
	<isNotEmpty    property="entity.code">
		AND PGCODE  LIKE '%'||#entity.code#||'%'
	</isNotEmpty>
	<isNotEmpty    property="entity.parkingLotArea.name">
		AND PLANAME  LIKE '%'||#entity.parkingLotArea.name#||'%'
	</isNotEmpty>
	<isNotEmpty    property="entity.parkingLotArea.parkingLot.name">
		AND PLNAME  LIKE '%'||#entity.parkingLotArea.parkingLot.name#||'%'
	</isNotEmpty>
</select> 
	
</sqlMap>


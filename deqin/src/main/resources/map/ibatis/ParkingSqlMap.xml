<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" 
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap> 
	
	
	<!-- 根据车位编号修改停车位状态 -->
	<update id="updateParkingGarageByName.update" parameterClass="map">
		update t_parking_garage set is_online = #isOnline#,car_no=#carNo#,intime=#intime#
			where name=#name#
	</update>
	
	<!-- 更新校区管理停车位数量 -->
	<update id="updateParkinglotCarNumber.update" parameterClass="map">
		UPDATE T_PARKING_LOT TPL SET TPL.CAR_NUMBER = 
		(
		SELECT
			SUM (
				T_PARKING_LOT_AREA.CAR_NUMBER
			)
		FROM
			T_PARKING_LOT_AREA
		WHERE T_PARKING_LOT_AREA.PARKING_LOT_ID = TPL.ID AND T_PARKING_LOT_AREA.IS_ENABLED = 1
		GROUP BY
			T_PARKING_LOT_AREA.PARKING_LOT_ID
		)
	</update>
	
	<!-- 更新校区片区管理停车位数量 -->
	<update id="updateParkinglotAreaCarNumber.update" parameterClass="map">
		UPDATE T_PARKING_LOT_AREA TPLA SET TPLA.CAR_NUMBER = 
		(
		SELECT
			COUNT (
				T_PARKING_GARAGE.PARKING_LOT_AREA_ID
			)
		FROM
			T_PARKING_GARAGE
		WHERE T_PARKING_GARAGE.PARKING_LOT_AREA_ID = TPLA.ID AND T_PARKING_GARAGE.IS_ENABLED =1 AND T_PARKING_GARAGE.IS_ONLINE=0
		GROUP BY
			T_PARKING_GARAGE.PARKING_LOT_AREA_ID
		)
	</update>
	<!-- 预定成功后修改是否预定为1-->
	<update id="updateParkingGarageYuding.update" parameterClass="map">
		update t_parking_garage set IS_YUDING = #isYuDing#,YUDING_CARNO=#yudingCarNo# where id=#id#
	</update>
	
	<!-- 查询某一个区域下所有的可以预约的车位 -->
	<select id="queryParkingGarage.select" resultClass="mapBean" parameterClass="map" >
	
SELECT
			T_PARKING_GARAGE.*
		FROM
			T_PARKING_GARAGE,T_PARKING_LOT_AREA
		WHERE
			(
				T_PARKING_GARAGE.CAR_NO IS NULL
				OR T_PARKING_GARAGE.CAR_NO = 'empty'
			)
		AND T_PARKING_GARAGE.IS_ONLINE = 0
		AND (T_PARKING_GARAGE.is_yuding IS null or T_PARKING_GARAGE.is_yuding = 0)
		AND T_PARKING_GARAGE.yuding_carno is null
    and T_PARKING_GARAGE.PARKING_LOT_AREA_ID=T_PARKING_LOT_AREA.ID
    and T_PARKING_LOT_AREA.FULL_INDEX_NAME like ''||#fullIndexName# || '%'
		 
	</select>
	
	
</sqlMap>


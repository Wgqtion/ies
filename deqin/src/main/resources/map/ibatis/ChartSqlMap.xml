<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" 
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap> 
	
<!-- 停车场余位统计 -->
<select id="chart.parkingSurplusTotal.total" resultClass="mapBean" parameterClass="com.vsc.modules.entity.ReportView" >
	SELECT
		PLNAME AS name,"SUM"(STATUS) AS surplustotal
	FROM
		(
			SELECT
				NVL(PL."NAME",'未分配') AS PLNAME,
				NVL(PL."ID",-1) AS PLID,
				PV.STATUS
			FROM
				(
					SELECT
						*
					FROM
						(
							SELECT
								PARKING_NAME,
								CREATE_TIME,
								CAMERA_IP,
								STATUS,
								PLATE_NO,
								IN_TIME,
								ROW_NUMBER () OVER (
									PARTITION BY PARKING_NAME
									ORDER BY
										CREATE_TIME DESC,
										"ID" DESC
								) rn
							FROM
								T_PARKING_VIDEO
						) PV
					WHERE
						rn = 1
				) PV
			LEFT JOIN T_PARKING_GARAGE PG ON PG."NAME" = PV.PARKING_NAME
			LEFT JOIN T_PARKING_LOT_AREA PLA ON PG.PARKING_LOT_AREA_ID = PLA."ID"
			LEFT JOIN T_PARKING_LOT PL ON PLA.PARKING_LOT_ID = PL."ID"
		) SurplusTotal
	GROUP BY 
		PLID,PLNAME
	ORDER BY 
		PLID DESC
</select>
	
	
	<!-- 停车场进出次数统计-->
	<select id="chart.parkingInOutTotal.total" resultClass="mapBean" parameterClass="com.vsc.modules.entity.ReportView" >
		SELECT 
			PT.$selectType$NAME AS name,INCAR.innum,OUTCAR.outnum
		FROM
		(
			SELECT 
				PL."NAME" AS PLNAME,PL."ID" AS PLID,PAS."NAME" AS PASNAME,PAS."ID" AS PASID
			FROM
				T_PARKING_LOT PL
			LEFT JOIN T_PASSAGES PAS ON PL."ID"=PAS.PARKINGLOT_ID
		)  PT 
		
		LEFT JOIN (
			SELECT 
				COUNT(*) innum,
				$selectType$."ID" AS $selectType$ID
			FROM 
				T_PARKING_ORDER PO
			LEFT JOIN T_PASSAGES PAS ON PO.IN_SCHOOL_DOOR_NAME=PAS."ID"
			LEFT JOIN T_PARKING_LOT PL ON PL."ID"=PAS.PARKINGLOT_ID  
			WHERE 
				1=1
				<isNotEmpty    property="startDate">
				AND <![CDATA[to_char(PO.IN_TIME,'yyyy-MM-dd') >= #startDate#]]>
				</isNotEmpty>
				<isNotEmpty    property="endDate">
				AND <![CDATA[to_char(PO.IN_TIME,'yyyy-MM-dd') <= #endDate#]]>			 
				</isNotEmpty>
			GROUP BY 
				$selectType$."ID"
		)	INCAR ON INCAR.$selectType$ID=PT.$selectType$ID
		LEFT JOIN (
			SELECT 
				COUNT(*) outnum,
				$selectType$."ID" AS $selectType$ID
			FROM 
				T_PARKING_ORDER PO
			LEFT JOIN T_PASSAGES PAS ON PO.OUT_SCHOOL_DOOR_NAME=PAS."ID"
			LEFT JOIN T_PARKING_LOT PL ON PL."ID"=PAS.PARKINGLOT_ID  
			WHERE 
				1=1
				<isNotEmpty    property="startDate">
				AND <![CDATA[to_char(PO.OUT_TIME,'yyyy-MM-dd') >= #startDate#]]>
				</isNotEmpty>
				<isNotEmpty    property="endDate">
				AND <![CDATA[to_char(PO.OUT_TIME,'yyyy-MM-dd') <= #endDate#]]>			 
				</isNotEmpty>
			GROUP BY 
				$selectType$."ID"
		)	OUTCAR ON OUTCAR.$selectType$ID=PT.$selectType$ID
		WHERE 
			1=1
			<isNotEmpty    property="selectId">
			AND PT.PLID=#selectId#
			</isNotEmpty>
		GROUP BY 
				PT.$selectType$NAME,INCAR.innum,OUTCAR.outnum
		ORDER BY PT.$selectType$NAME
	</select>
	
	<!-- 停车场收费统计-->
	<select id="chart.parkingChargeTotal.total" resultClass="mapBean" parameterClass="com.vsc.modules.entity.ReportView" >
	
		SELECT 
			PT.$selectType$NAME AS name,
			SUM(ysPayAmount) AS yspayamount,
			SUM(ssPayAmount) AS sspayamount
		FROM
		(
			SELECT 
				SUM(YS_PAY_AMOUNT) AS ysPayAmount,
				SUM(SS_PAY_AMOUNT) AS ssPayAmount,
				NVL($selectType$."ID",-1) AS $selectType$ID,
				NVL($selectType$."NAME",'未分配') AS $selectType$NAME
			FROM 
				T_PARKING_ORDER PO
			LEFT JOIN T_PASSAGES PAS ON PO.IN_SCHOOL_DOOR_NAME=PAS."ID"
			LEFT JOIN T_PARKING_LOT PL ON PL."ID"=PAS.PARKINGLOT_ID  
			WHERE 
				1=1 AND (IN_SCHOOL_DOOR_NAME IS NOT NULL OR (OUT_SCHOOL_DOOR_NAME IS NOT NULL AND IN_SCHOOL_DOOR_NAME IS NULL))
				
				<isNotEmpty    property="selectId">
				AND PL."ID"=#selectId#
				</isNotEmpty>
				
				<isNotEmpty    property="startDate">
				AND <![CDATA[to_char(PO.PAY_TIME,'yyyy-MM-dd') >= #startDate#]]>
				</isNotEmpty>
				<isNotEmpty    property="endDate">
				AND <![CDATA[to_char(PO.PAY_TIME,'yyyy-MM-dd') <= #endDate#]]>			 
				</isNotEmpty>
			GROUP BY 
				NVL($selectType$."ID",-1),
				NVL($selectType$."NAME",'未分配')
				
				
				
			UNION ALL
			
			
			SELECT 
				SUM(YS_PAY_AMOUNT) AS ysPayAmount,
				SUM(SS_PAY_AMOUNT) AS ssPayAmount,
				NVL($selectType$."ID",-1) AS $selectType$ID,
				NVL($selectType$."NAME",'未分配') AS $selectType$NAME
			FROM 
				T_PARKING_ORDER PO
			LEFT JOIN T_PASSAGES PAS ON PO.IN_SCHOOL_DOOR_NAME=PAS."ID"
			LEFT JOIN T_PARKING_LOT PL ON PL."ID"=PAS.PARKINGLOT_ID  
			WHERE 
				1=1 AND (IN_SCHOOL_DOOR_NAME IS NULL AND OUT_SCHOOL_DOOR_NAME IS NULL)
				
				<isNotEmpty    property="selectId">
				AND PL."ID"=#selectId#
				</isNotEmpty>
				
				<isNotEmpty    property="startDate">
				AND <![CDATA[to_char(PO.PAY_TIME,'yyyy-MM-dd') >= #startDate#]]>
				</isNotEmpty>
				<isNotEmpty    property="endDate">
				AND <![CDATA[to_char(PO.PAY_TIME,'yyyy-MM-dd') <= #endDate#]]>			 
				</isNotEmpty>
			GROUP BY 
				NVL($selectType$."ID",-1),
				NVL($selectType$."NAME",'未分配')
		)  PT 
		GROUP BY 
				PT.$selectType$ID,PT.$selectType$NAME
		ORDER BY PT.$selectType$ID DESC
	</select>
	
</sqlMap>